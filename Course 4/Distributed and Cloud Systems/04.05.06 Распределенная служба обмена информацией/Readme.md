# 04.05.06 Распределенная служба обмена информацией

## База знаний
1. АСТИ — автоматическая система телеизмерений
2. АСУРР — автоматизированная система учета транспорта и распределения ресурсов
3. ТО — территориальная организация
4. ГО — головная организация
5. б/д ТИ — базы данных телеизмерений
6. РСОИ — распределенная служба обмена информацией
7. АСКУРР - Автоматизированная система контроля учета и распределения ресурсов

### 3.1 Технический проект РСОИ: Назначение и принципы организации

1. **Назначение РСОИ:**
   - Обеспечивает обмен данными между унифицированной базой обмена данными (БОД) головной организации (ГО) и базами данных территориальных организаций (ТО).
   - Используется для передачи данных между организациями с помощью веб-сервисов, работающих на серверах под управлением ОС Windows (У меня будет на линуксе, я панк).

2. **Принципы реализации:**
   - Все базы данных БОД имеют унифицированную структуру таблиц.
   - РСОИ представляет собой распределенную систему, работающую одновременно на серверах ГО и ТО.
   - Данные, передаваемые системой, классифицируются по источникам, с периодической или непериодической передачей.
   - Для идентификации источников используется поле **IST** в таблицах BODK и BODI.
   - Важная служебная база данных **N_TI** управляет составом передаваемых данных и редко обновляется.

3. **Централизованная модель обмена:**
   - Данные передаются из БОД ТО только в БОД ГО, прямой обмен между ТО запрещен.
   - Данные из БОД ГО могут возвращаться обратно в ТО.
   - Обновление базы N_TI выполняется в ГО и вручную распространяется на сервера ТО.

4. **Функции службы РСОИ:**
   - В ГО: сбор данных от ТО, размещение данных в БОД ГО, передача данных в ТО.
   - В ТО: передача данных в ГО, прием данных от ГО.

5. **Алгоритмы работы системы:**
   - Обмен данными происходит асинхронно, данные могут поступать в разное время из-за разной пропускной способности каналов связи, загрузки серверов, а также несинхронизированного времени на серверах.

### 3.1.2 Принцип автоматического обмена данными

1. **Основной принцип автоматического обмена данными**:
   - Создание баз данных унифицированной структуры (БОД), которые организуются в виде таблиц **BODI** и **BODK**. Ключевые поля этих таблиц используют коды справочников, общих для всех участников отрасли.
   - Данные автоматически записываются в БОД с определенной цикличностью или по графику внешними программами территориальных организаций (ТО). Эти данные необходимы для выполнения задач другими субъектами сети, и их состав согласовывается заранее.
   - Сервер РСОИ субъекта-поставщика данных автоматически посылает запрос серверу РСОИ субъекта-получателя для чтения данных по определенному графику или цикличности. Сервер-получатель затем читает, анализирует и записывает данные в свою БОД.

2. **Технические требования для автоматического обмена данными**:
   - У участника корпоративной сети (КС) должны быть:
     - Сервер СУБД, поддерживающий язык SQL.
     - WWW-сервер.
     - Сервер веб-приложений, работающий под ОС Windows (если используется соответствующее ПО РСОИ).

3. **Обеспечение корректности временных данных**:
   - Синхронизация текущего времени для серверов РСОИ происходит через службу времени корпоративной сети.
   - Каждая строка (запись) в БОД содержит поле с датой и временем для точного учета времени передачи данных.

### 3.1.3 Структура базы обмена данными (БОД)

При разработке структуры БОД использовались следующие принципы:

1. **Универсальность**:
   - БОД способна хранить информацию различного характера: технологическую, экономическую, фактическую и прогнозную, а также как исходные данные, так и результаты расчетов.
   - Универсальность достигается за счет наличия полей, которые описывают все ключевые характеристики каждого показателя.

2. **Простота**:
   - БОД состоит из двух таблиц: основной (информационной) и вспомогательной (контрольной).
   - Справочники и классификаторы, используемые для кодирования данных, могут быть независимыми от БОД. Если они связаны, поддержание целостности данных осуществляется администратором базы данных (АБД) субъекта-поставщика.

3. **Ограниченный объем данных**:
   - В БОД хранится информация за ограниченное количество временных срезов (например, данные хранятся за сутки). После этого старые данные заменяются новыми, что позволяет избежать роста базы.

4. **Стандартизация**:
   - Использование единых справочников и классификаторов облегчает унификацию и процедуры согласования данных между участниками. Головная организация (ГО) отвечает за ведение и распространение справочников.

5. **Унификация с SQL-базой ГО**:
   - При создании БОД использовались методы организации и кодирования данных, а также справочники, применяемые в SQL-базе ГО.

### Состав таблиц базы обмена данными

БОД содержит две таблицы:
- **BODI** (информационная таблица) — основная таблица, в которой хранятся данные.
- **BODK** (контрольная таблица) — таблица для контроля данных.

#### Структура таблицы BODI

Таблица BODI содержит 12 столбцов:

- **Поля 3-10** — описывают показатель, записанный в поле 11.
- **Поля 1 и 2** — указывают источник данных и место хранения в базе данных ГО.
- **Поле 12** — указывает на признак, относящийся к значению показателя.

#### Описание ключевых полей таблицы BODI:

- **IST** (3 байта) — код источника данных, указывающий, какая система или комплекс предоставили данные. Коды источников информации содержатся в справочнике S_IST. Диапазон кодов: 101–199 (001–100 зарезервированы для уровня ГО).
  
- **TABL** (5 символов) — указывает на таблицу или источник данных.
  
- **POK** и **UT** — описывают сам показатель.
  
- **OBJ** — объект, к которому относится показатель, а **SUB** — субъект, отвечающий за этот объект.

- **VID** — тип информации (плановая, прогнозная, фактическая).
  
- **PER** — период времени, к которому относится показатель.

- **DATV** — временной штамп значения показателя, указывающий время создания данных.

- **PP** — признак достоверности данных.

Целостность данных таблицы BODI обеспечивается составным ключом, включающим поля: **IST, TABL, POK, UT, SUB, OTN, OBJ, VID, PER, DATV_SET**.

### Структура информационной области буфера обмена данными (BODI)

| № столбца (поля) | 1  | 2   | 3  | 4  | 5  | 6  | 7  | 8  | 9  | 10  | 11  | 12  | 13  |
|-------------------|----|-----|----|----|----|----|----|----|----|-----|-----|-----|-----|
| Информация, хранимая в столбце | Код источника данных | Код таблицы (в БД ГО) | Код показателя | Код уточнения показателя | Код субъекта | Код отношения | Код объекта | Код вида информации | Код периода | Дата-время | Дата-время | Значение показателя | Признак показателя |
| Имя столбца [Column Name] | IST | TABL | POK | UT | SUB | OTN | OBJ | VID | PER | DATV | DATV_SET | ZNC | PP |
| Тип данных [Datatype] | симв-цифр [char] | симв. [char] | симв-цифр [char] | симв-цифр [char] | симв-цифр [char] | симв-цифр [char] | симв-цифр [char] | симв-цифр [char] | симв-цифр [char] | datetime | datetime | число [float] | симв. [char] |
| Размер поля [Size], байт | 3 | 5 | 4 | 2 | 6 | 2 | 16 | 2 | 2 | 8 | 8 | 8 | 2 |
| Значение по умолчанию [Default] | - | - | - | 00 | - | 00 | 00000000 | 00000000 | - | - | - | 97979797 | 9797979 |
| Максимальное значение | 999 | - | 9999 | 99 | 999999 | 99 | 9999999 | 9999999 | 99 | 99 | 9999-12-31 23:59:59,999 | 9999-12-31 23:59:59,999 | 1.7E+308 (мантисса 15 знаков) | - |

*Рис. 2. Структура информационной области буфера обмена данными (BODI)*

---

### Структура контрольной области буфера обмена данными (BODK)

| № столбца (поля) | 1  | 2   | 3                      | 4                      |
|-------------------|----|-----|------------------------|------------------------|
| Информация, хранимая в столбце | Код источника данных | Код субъекта отрасли | Дата-время записи в таблицу BODI | Количество строк (записей) |
| Имя столбца [Column Name] | IST | SUB | DATV_SET              | KZAP                   |
| Тип данных [Datatype] | симв-цифр [char] | симв-цифр [char] | datetime              | целое число [smalint] |
| Размер поля [Size], байт | 3  | 6   | 8                      | 2                      |
| Значение по умолчанию [Default] | - | -   | -                      | -                      |
| Максимальное значение | 999 | 999999 | 9999-12-31 23:59:59,999 | 32767                  |

*Рис. 3. Структура контрольной области буфера обмена данными (BODK)*

#### Описание полей:
- Поля **IST**, **SUB** и **DATV_SET** аналогичны полям таблицы BODI.
- Поле **DATV_SET** содержит время начала интервала, к которому относятся значения показателей, хранимых в таблице BODI.
- Поле **KZAP** содержит количество записей, помещенных в таблицу BODI для данного пятиминутного интервала.

#### Целостность данных
Целостность данных таблицы BODK обеспечивается использованием составного ключа, включающего поля **IST**, **SUB**, **DATV_SET** и **KZAP**.

### 3.1.4 Служебная база данных N_TI

Служебная база данных N_TI предназначена для хранения информации, необходимой для функционирования программного обеспечения, обеспечивающего сервисы обмена информацией унифицированной структуры. 

#### Преимущества использования служебной базы данных:
- Позволяет вынести информацию о данных в отдельный источник, облегчая разработку программного кода приложений.
- Централизованное обновление базы данных осуществляется специалистами головной организации (ГО) и распространяется по всем участникам обмена данными.

#### Таблицы служебной базы данных:
1. **T_IST**: таблица источников, которая содержит коды источников данных и временные параметры обработки данных.
2. **T_SUB**: таблица субъектов, содержащая коды субъектов-поставщиков информации и их сетевые имена.
3. **T_S_N**: таблица серийных номеров, содержащая коды, характеризующие степень новизны данных.
4. **N_TI**: основная таблица, содержащая полные коды всех полей, используемые при обмене данными. Она позволяет проверять правильность кодировки.

### Структура таблицы N_TI

| Поле     | Тип      | Размер поля | Null | Обязательное поле | Значение по умолчанию | Описание               |
|----------|----------|-------------|------|-------------------|-----------------------|------------------------|
| IST      | текстовый| 3 байта    | нет  | да                | нет                   | код источника          |
| TABL     | текстовый| 5 байт     | нет  | да                | нет                   | имя таблицы            |
| POK      | текстовый| 4 байта    | нет  | да                | нет                   | код показателя         |
| UT       | текстовый| 2 байта    | нет  | да                | нет                   | код уточнения          |
| SUB      | текстовый| 6 байт     | нет  | да                | нет                   | код субъекта           |
| OTN      | текстовый| 2 байта    | нет  | да                | нет                   | код отношения          |
| OBJ      | текстовый| 16 байт    | нет  | да                | нет                   | код объекта            |
| VID      | текстовый| 2 байта    | нет  | да                | нет                   | код вида информации    |
| PER      | текстовый| 2 байта    | нет  | да                | нет                   | код периода            |
| N_TI     | числовой | целое      | нет  | да                | 0                     | номер ТИ               |
| SUB_R    | текстовый| 6 байт     | нет  | да                | нет                   | код получателя         |
| NAME     | текстовый| 50 байт    | да   | нет               | нет                   | имя объекта            |
| ACT      | числовой | байт       | нет  | да                | 1                     | актуальность           |

### Структура таблицы T_IST

| Поле     | Тип      | Размер поля | Null | Обязательное поле | Значение по умолчанию | Описание                    |
|----------|----------|-------------|------|-------------------|-----------------------|-----------------------------|
| IST      | текстовый| 3 байта    | нет  | да                | нет                   | код источника               |
| PERIOD   | текстовый| 3 байта    | нет  | да                | нет                   | период обмена               |
| ED       | текстовый| 1 байт     | нет  | да                | нет                   | m - минуты, d - дни, h - часы, N - асинхронная |
| DT_BEG   | текстовый| 2 байта    | нет  | да                | нет                   | задержка начала             |
| DT_END   | текстовый| 2 байта    | нет  | да                | нет                   | задержка окончания          |

### Структура таблицы T_S_N

| Поле     | Тип      | Размер поля | Null | Обязательное поле | Значение по умолчанию | Описание                    |
|----------|----------|-------------|------|-------------------|-----------------------|-----------------------------|
| IST      | текстовый| 3 байта    | нет  | да                | нет                   | код источника               |
| SUB      | текстовый| 6 байт     | нет  | да                | нет                   | код субъекта                |
| S_N      | текстовый| 01 байт    | нет  | да                | нет                   | серийный номер              |

### Структура таблицы T_SUB

| Поле        | Тип      | Размер поля | Null | Обязательное поле | Значение по умолчанию | Описание                     |
|-------------|----------|-------------|------|-------------------|-----------------------|------------------------------|
| ACT         | текстовый| 1 байт     | нет  | да                | 0                     | активность                   |
| SUB         | текстовый| 6 байт     | нет  | да                | нет                   | код                          |
| SUB_NAME    | текстовый| 5 байт     | нет  | да                | нет                   | имя                          |
| WITH_PROXY  | текстовый| 1 байт     | нет  | нет               | N                     | работа через прокси          |
| SUB_ADR     | текстовый| 50 байт    | нет  | да                | нет                   | IP-адрес или имя сайта      |
| SUB_PORT    | текстовый| 5 байт     | нет  | да                | 80                    | порт                         |
| SUB_PROXY   | текстовый| 60 байт    | нет  | нет               | нет                   | адрес прокси                 |
| SUB_PATH    | текстовый| 255 байт   | нет  | да                | нет                   | путь к документу            |
| SUB_PROXY_PORT | текстовый| 5 байт | нет  | нет               | нет                   | порт прокси                  |


### 3.2 Архитектура службы обмена данными унифицированной структуры

Архитектура службы, используемая для обмена данными между базами данных БОД различных предприятий, представлена на рис. 4. В этой архитектуре выделяются следующие ключевые компоненты:

- **Сервера службы обмена данными унифицированной структуры**: обеспечивают выполнение функций обмена данными между базами данных БОД предприятий.
- **Сервера баз данных**: хранят базы данных БОД предприятий.
- **Сервера оперативных данных**: поставляют информацию для размещения в таблицах баз данных БОД.
- **Сервера времени**: синхронизируют внутренние часы всех серверов, участвующих в обмене.

### Базовое ПО

Базовое программное обеспечение серверов службы обмена данными унифицированной структуры включает в себя:

- **Операционная система**: Windows.
- **Сервер приложений**: Cold Fusion (при реализации службы РСОИ на базе данного ПО).
- **WWW-сервер**: тип сервера зависит от варианта реализации основного ПО.

Это ПО формирует операционное окружение, в котором выполняются программы, обеспечивающие обмен данными.

### Основное ПО серверов службы обмена данными

Основное ПО включает следующие компоненты:

1. **Служебная база данных N_TI**: содержит перечень показателей, относящихся к каждому источнику данных, а также коды субъектов и объектов, к которым относится значение показателей.
2. **ПО Trans_bod**: работает как сервис ОС Windows NT и выполняет следующие функции:
   - Запускается каждую минуту.
   - Определяет наличие данных в БОД для данного источника и текущего временного интервала.
   - При наличии данных для каждого сервера получателя формирует текстовый файл данных унифицированного формата.
   - Выполняет запрос к сервису Receive_bod на удаленном сервере РСОИ, заставляя его прочитать данные, подготовленные для передачи.
   - Проверяет, все ли данные, предназначенные для передачи, были обработаны; если не все, устанавливает соответствующие признаки повторной обработки при следующем запуске.
   - Повторяет действия для следующего источника, если время его обработки наступило.

3. **ПО Receive_bod**: предназначено для приема данных от удаленного сервиса Trans_bod. Реализуется как сервис ОС Windows NT, запуск осуществляется асинхронно с помощью HTTP-запроса от удаленного сервиса Trans_bod. Сервис выполняет следующие функции:
   - Принимает вызов от удаленного сервиса Trans_bod.
   - Читает файл данных с удаленного Web-сервера.
   - Заносит поступившие данные в локальный БОД.

4. **Вспомогательное ПО**: включает в себя:
   - Клиент службы времени.
   - ПО запуска служб (планировщик задач).
   - ПО ротации файлов журналов (лог-файлов) работы основных и базовых служб.
   - ПО удаленного просмотра состояния БОД предприятий.

### Протоколы связи

Для связи между компонентами системы используются следующие протоколы:
- Для взаимодействия с серверами СУБД, хранящими базы данных БОД и служебной базой N_TI применяются протоколы **TCP/IP**, **ODBC** и **OLE DB**.
- Для синхронизации времени серверов используется протокол **NTP**.
- Для синхронизации между компонентами ПО обмена данными и обмена данными между ними используется протокол **HTTP**.

### Принципы обмена данными

1. **Запрещение записи в удаленные базы данных БОД**: Этот принцип гарантирует сохранение контроля за содержимым баз данных БОД ТО. Обмен данными разрешен только между БОД ГО и БОД ТО, но не между БОД ТО и БОД ТО. Это обеспечивает необходимый уровень информационной безопасности.
   
2. **Предварительное определение состава информации**: Состав информации (показателей), участвующих в обмене, определяется заранее путем заполнения соответствующих таблиц служебной базы данных N_TI.

### Этапы обмена данными

Процесс обмена данными состоит из двух этапов:
- Размещение данных в базах данных БОД.
- Перенос данных из внешнего БОД (БОД другого предприятия) во внутренний БОД.

#### Синхронизация этапов обмена данными

- Перемещение данных между сервером оперативных данных и локальной базой данных БОД стартует асинхронно на каждом предприятии с помощью планировщика задач. Степень рассинхронизации зависит от времени появления оперативных данных.
- Параллельно с занесением оперативных данных в БОД циклически запускается сервис **Trans_bod**, который анализирует наличие данных для передачи по каждому источнику с помощью чтения таблицы BODK. Когда в BODK появляется запись для обрабатываемого источника и текущего временного интервала, сервис формирует текстовый файл данных для каждого ТО получателя и вызывает сервис Receive_bod соответствующих ТО.

### 3.3.1 Прикладное ПО

Прикладное программное обеспечение (ПО) для службы РСОИ включает в себя как основные, так и вспомогательные компоненты, обеспечивающие эффективный обмен данными между базами данных БОД ГО (государственного уровня) и БОД ТО (территориального уровня).

#### Основные компоненты прикладного ПО:

1. **Сервис Trans_bod**:
   - Основной компонент, который отвечает за подготовку и передачу данных.
   - Выполняет следующие функции:
     - Запускается периодически (например, каждую минуту).
     - Проверяет наличие данных в БОД для заданного источника и временного интервала.
     - Формирует текстовые файлы унифицированного формата для передачи на сервера получателей.
     - Запрашивает у сервиса Receive_bod прием данных.

2. **Сервис Receive_bod**:
   - Обеспечивает прием данных, отправленных от сервиса Trans_bod.
   - Выполняет следующие функции:
     - Принимает вызовы от Trans_bod.
     - Читает и обрабатывает файл данных.
     - Вносит полученные данные в локальную базу данных БОД.

#### Вспомогательное ПО:

1. **Клиент службы времени**:
   - Поддерживает протокол NTP (Network Time Protocol) для синхронизации времени между серверами, участвующими в обмене данными.

2. **ПО ротации файлов журналов**:
   - Управляет созданием, хранением и удалением лог-файлов, обеспечивая порядок в ведении записей о работе служб.

3. **ПО просмотра БОД**:
   - Предоставляет интерфейс для мониторинга состояния и содержимого баз данных БОД.

4. **ПО запроса сервиса Trans_bod**:
   - Используется для инициирования запросов на обмен данными с сервиса Trans_bod.

### Заключение
Эти компоненты в совокупности образуют мощную платформу для обмена данными между различными уровнями управления, обеспечивая стабильность, эффективность и безопасность передачи информации.

### 3.4. Рекомендации по использованию техпроекта

При использовании данного техпроекта рекомендуется учитывать следующие обстоятельства и предложения:

1. **Устаревание технологии**:
   - Техпроект был разработан более 15 лет назад, когда принципы построения сервис-ориентированной архитектуры распределенных систем еще не были четко сформулированы.
   - На момент разработки существовали лишь начальные идеи о работе с XML, и инструментальные средства для этого были ограничены.
   - Текущий техпроект предполагает использование веб-приложений, которые, в отличие от современных стандартов, генерируют текстовые документы с данными, а не HTML-документы. В качестве платформы для построения таких приложений использовался сервер приложений Cold Fusion от фирмы Allaire.

2. **Переход на веб-сервисы**:
   - Рекомендуется заменить веб-приложения на современные веб-сервисы, что позволит улучшить гибкость, масштабируемость и интеграцию системы с другими сервисами и приложениями.

3. **Выбор системы управления базами данных (СУБД)**:
   - В качестве СУБД можно использовать любую подходящую по выбору систему, которая отвечает требованиям производительности, безопасности и совместимости.

4. **Изменение алгоритмов**:
   - Алгоритмы, описанные в техпроекте, могут быть изменены при условии, что это не повлечет за собой изменение реализуемых функций. Любые изменения должны быть тщательно протестированы для обеспечения корректности работы системы.

5. **Конфигурационные параметры**:
   - Основные параметры, определяющие работу системы, не должны кодироваться в текстах программных единиц. Вместо этого они должны считываться из конфигурационных файлов при старте или перезапуске сервисов системы. Это обеспечит большую гибкость и упростит управление настройками без необходимости изменения исходного кода.